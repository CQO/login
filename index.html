<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <!-- 页面的元信息 -->
  <title>管理后台</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no, email=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="white" />
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="filetype" content="1" />
  <meta name="publishedtype" content="1" />
  <meta name="pagetype" content="2" />
  <style>
    /* 这个文件里写的是全局样式,在各个页面都生效 */
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      user-select: text;
      height: 100%;
      font-size: 14px;
      font-family: 'pingfang SC','helvetica neue',arial,'hiragino sans gb','microsoft yahei ui','microsoft yahei','simsun',sans-serif;
      -webkit-overflow-scrolling: touch;
      overflow: hidden;
    }
    html {
      background-color: white;
      background-repeat: no-repeat;
      background-position: center top;
      background-size: cover;
    }
    body, html, .page {
      padding: 0;
      margin: 0;
      position: relative;
      height: 100%;
    }
    h1, h2, h3, h4, h5, input {
      margin: 0;
      padding: 0;
    }
    ul, li {
      list-style-type: none;
    }

    a {
      cursor: pointer;
      text-decoration: none;
    }
    a:hover {
      color: initial;
      text-decoration: underline;
    }

    h1, h2, h3, h4, h5, h6, hr, p, blockquote, dl, dt, dd, ul, ol, li, pre, form, button, input, textarea, th, td{
      margin:0;
      padding:0;
    }

    .clear:after {
      content: "";
      height: 0;
      line-height: 0;
      display: block;
      visibility: hidden;
      clear: both;
    }

    .w1000 {
      width: 1000px;
      margin: 0 auto;
    }

    .w1200 {
      width: 1200px;
      margin: 0 auto;
    }

    .h20 {
      height: 20px;
    }

    .h30 {
      height: 30px;
    }

    .fl {
      float: left;
    }

    .fr {
      float: right;
    }

    .pc .no-pc, .phone .no-phone {
      display: none;
    }
    body, html, .page, .page-box {
      padding: 0;
      margin: 0;
      width: 100%;
    }

    .owo-animation {
      overflow: hidden;
      -webkit-backface-visibility: hidden;
      -moz-backface-visibility: hidden;
      backface-visibility: hidden;
      -webkit-transform: translate3d(0, 0, 0);
      -moz-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
      -webkit-transform-style: preserve-3d;
      -moz-transform-style: preserve-3d;
      transform-style: preserve-3d;
    }
    .owo-animated {
      -webkit-animation-duration: 1s;
      animation-duration: 1s;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
    }
    .owo-animation-forward {
      z-index: 99;
    }

    img {
      border: none;
    }

    [route-active="false"] {
      display: none;
    }

    /* 清除浮动 */
    .clear:after {
      content: "";
      height: 0;
      line-height: 0;
      display: block;
      visibility: hidden;
      clear: both;
      zoom: 1;
    }

    ul {
      margin: 0;
      padding: 0;
    }

    li {
      list-style: none;
    }

    .login {
      width: 100%;
      height: 100%;
      background-color: white;
    }

    .login .login-title-bar {
      display: flex;
      justify-content: space-between;
      height: 45px;
      align-items: center;
    }

    .login .login-title-bar .back {
      width: 12px;
      margin: 13px;
      display: block;
    }

    .login .login-title-bar .register {
      font-size: 20px;
      line-height: 45px;
      padding-right: 10px;
    }

    .login .login-title-bar .active {
      opacity: 0;
      -webkit-user-select: none;
        -moz-user-select: none;
              user-select: none;
      pointer-events: none;
    }

    .login .button-box {
      margin-top: 35px;
    }

    .login .image-box img {
      height: 160px;
      display: block;
      margin: 20px auto;
    }

    .login .hellow-text {
      color: #5fccff;
      font-size: 22px;
      width: 100%;
      text-align: center;
      line-height: 40px;
    }

    .login .button {
      background-color: #5fccff;
      line-height: 50px;
      text-align: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      width: 84%;
      margin: 0 auto;
      border-radius: 25px;
      display: block;
      margin-top: 15px;
    }

    .login input {
      border: none;
      display: block;
      width: 83%;
      font-size: 18px;
      border-radius: 25px;
      outline: none;
    }

    .login .view-login input {
      border: none;
      background-color: transparent;
      height: 100%;
      padding-left: 17%;
      display: block;
      width: 83%;
      font-size: 18px;
      border-radius: 25px;
      outline: none;
    }

    .login .view-login input:active {
      box-shadow: 1px 1px 5px #ccc;
    }

    .login .view-login .input-bar {
      background-color: #f7f8fa;
      height: 50px;
      border-radius: 25px;
      width: 84%;
      margin: 20px auto;
      position: relative;
      overflow: hidden;
    }

    .login .view-login .input-bar .bar-icon {
      width: 20px;
      position: absolute;
      left: 20px;
      top: 0px;
      bottom: 0;
      margin: auto;
    }

    .login .tool-bar {
      line-height: 50px;
      display: flex;
      justify-content: space-between;
      width: 84%;
      margin: 0 auto;
      color: #262626;
      font-size: 14px;
    }

    .login .router {
      height: calc(100% - 45px);
      overflow: hidden;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .login .router [route] {
      width: 100%;
      height: 100%;
    }

    .login .view-register {
      width: 100%;
      height: 100%;
    }

    .login .view-register .bg-1 {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 47vw;
    }

    .login .view-register p {
      line-height: 40px;
      font-size: 23px;
      padding-top: 60px;
      z-index: 99;
      background-image: url(//cunchu.site/puge/login/Signup.png);
      background-size: 91vw;
      background-repeat: no-repeat;
      background-position-y: 15px;
      padding-left: 20px;
      font-weight: bold;
      margin-bottom: 40px;
    }

    .login .view-register .register-input {
      height: 50px;
      background-color: #f7f7fb;
      margin: 0 auto;
      margin-top: 20px;
      padding: 0 5%;
      width: 74%;
    }

    .login .view-register .button {
      background-color: #fa4169;
    }

    .login .mini-box {
      width: 84%;
      margin: 0 auto;
    }

    .login .mini-box .button {
      background-color: #009fe9;
      float: right;
      width: 24%;
      display: block;
      font-size: 14px;
      height: 40px;
      line-height: 40px;
      margin-top: 23px;
    }

    .login .mini-box .register-input {
      float: left;
      width: 60%;
      display: block;
    }
  </style>

</head>

<body>
  <!-- 页面[login]-->
  <div class="login page" template="login" style="display: none;">
    <div class="router" view="loginContent">
      <div class="view-login" route="login">
        <div class="image-box">
          <img src="//cunchu.site/puge/login/image-box.png">
        </div>
        <div class="hellow-text">嗨，欢迎回来!</div>
        <div class="user-name-bar input-bar">
          <img class="bar-icon" src="//cunchu.site/puge/login/user.png">
          <input type="text" o-value="this.data.username" placeholder="用户名">
        </div>
        <div class="pass-word-bar input-bar">
          <img class="bar-icon" src="//cunchu.site/puge/login/password.png">
          <input type="password" o-value="this.data.password" placeholder="密码">
        </div>
        <div class="button-box">
          <div class="button" o-tap="login" o-hover="radial-out">登录</div>
          <div class="button" o-hover="radial-out" style=" background-color: burlywood;" go="/view-loginContent=register">注册</div>
        </div>
        <div class="tool-bar">
          <div class="left"></div>
          <div class="right">
            <a href="https://cunchu.site/work/login/forget.html">忘记密码</a>
          </div>
        </div>
      </div>
      <div class="view-register" route="register">
        <img class="bg-1" src="//cunchu.site/puge/login/art.png">
        <p>欢迎注册账号</p>
        <input class="register-input" type="text" o-value="this.data.registerusername" placeholder="用户名">
        <input class="register-input" type="password" o-value="this.data.registerPassWord" placeholder="密码">
        <input class="register-input" type="password" o-value="this.data.registerPassWordR" placeholder="确认密码">
        <div class="mini-box clear">
          <input class="register-input" type="text" o-value="this.data.registerPhone" placeholder="手机号码">
          <div class="button" o-tap="sendSMS">发送验证码</div>
        </div>
        <input class="register-input" type="text" o-value="this.data.registerCode" placeholder="验证码">
        <div class="button" o-tap="register">注册</div>
      </div>
    </div>
  </div>

  <!-- 框架script文件 -->
  <script src="./static/js/owo.core.3ugw4oy4z93.js" type="text/javascript" charset="UTF-8"></script>
  <script type="text/javascript" charset="UTF-8">
    function getQueryVariable(variable, url) {
       var query = window.location.search.substring(1);
       if (url) {
         query = url.split('?')[1]
       }
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
    }
    // 模块 login 的script代码
    var appType = getQueryVariable('appType');
    if (!appType) window.parent.postMessage(JSON.stringify({"type":"owoError", "data": "appType未设置!"}));
    var userInfo = localStorage.getItem("owoUserInfo_" + appType);
    userInfo = JSON.parse(userInfo);
    if (userInfo) {
      console.log(userInfo)
      if (userInfo.username && userInfo.session) {
        getDataFormSession(userInfo.username, userInfo.session)
      } else {
        window.parent.postMessage(JSON.stringify({"type":"owoNeedLogin", "data": ""}));
      }
    } else {
      window.parent.postMessage(JSON.stringify({"type":"owoNeedLogin", "data": ""}));
    }
    function getDataFormSession(username, session, callBack) {
      fetch("//service-eqp55afi-1256763111.gz.apigw.tencentcs.com/release/loginSession", {
        method: 'POST',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          type: appType,
          username: username,
          session: session
        })
      }).then(function(response) {
        return response.json();
      }).then(function(res) {
        console.log(res);
        if (res.err === 0) {
          owo.state.userInfo = res.data;
          localStorage.setItem('owoUserInfo_' + appType, JSON.stringify(res.data));
          window.parent.postMessage(JSON.stringify({"type":"owoLoginSuccess", "data": res.data}));
          if (callBack) callBack(res.data)
        } else {
          window.parent.postMessage(JSON.stringify({"type":"owoError", "data": res.message}));
        }
      });
    }

    function link() {
      window.owoSocket = new WebSocket('wss://port.run:8083');
      // 断线重连
      window.owoSocket.onerror = function() {
        reconnect();
      };
      // 重连
      function reconnect(service) {
        // lockReconnect加锁，防止onclose、onerror两次重连
        timeConnect++;
        console.log("第" + timeConnect + "次重连");
        // 进行重连
        setTimeout(function() {
          window.owoSocket = new WebSocket('wss://port.run:8083');
        }, 3000);
      }
      window.owoSocket.addEventListener('open', function(event) {
        window.owoSocket.send(JSON.stringify({
          "route": "login",
          "type": "debuger",
          "id": owo.state.userInfo.username
        }));
      });
      window.owoSocket.addEventListener('message', function(event) {
        var mess = JSON.parse(event.data);
        switch (mess.type) {
          case "close":
            alert('账号在别处登录,请重新登录!');
            window.owoSocket.close();
            owo.state.userInfo.session = '';
            localStorage.setItem('owoUserInfo_' + appType, JSON.stringify({}));
            window.location.replace("");
            break;
          default:
            break;
        }
      });
    }

    function saveOpenID(openid) {
      fetch("//service-eqp55afi-1256763111.gz.apigw.tencentcs.com/release/updataWeixin", {
        method: 'POST',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          username: owo.state.userInfo.username,
          session: owo.state.userInfo.session,
          type: appType,
          openid: openid
        })
      }).then(function(response) {
        return response.json();
      }).then(function(res) {
        if (res.err === 0) {
          console.log('提交成功!');
        } else {
          console.log("提交失败: " + res.message);
        }
      });
    }
    owo.script = {
      "login": {
        "data": {
          "registerusername": "",
          "registerPassWord": "",
          "registerPassWordR": "",
          "registerPhone": "",
          "registerCode": "",
          "username": "",
          "password": "",
          "session": null,
          "smsTime": 0
        },
        "created": function created() {
          // 自动加载用户名
          if (localStorage.getItem('username')) {
            this.data.username = localStorage.getItem('username');
          }
        },
        "login": function login() {
          fetch("//service-eqp55afi-1256763111.gz.apigw.tencentcs.com/release/login", {
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              type: appType,
              username: this.data.username,
              password: this.data.password
            })
          }).then(function(response) {
            return response.json();
          }).then(function(res) {
            console.log(res);
            if (res.err === 0) {
              window.parent.postMessage(JSON.stringify({"type":"owoLoginSuccess", "data": res.data}));
              owo.state.userInfo = res.data;
              localStorage.setItem('owoUserInfo_' + appType, JSON.stringify(res.data));
              setTimeout(function() {
                // 判断是否为app
                if (window.isApp && sendAppMessage) sendAppMessage('login', owo.state.userInfo);
                // 判断是否微信登陆
                if (window.openid && window.openid != res.data.weixin) {
                  saveOpenID(window.openid);
                }
              }, 0);
            } else {
              window.parent.postMessage(JSON.stringify({"type":"owoError", "data": res.message}));
            }
          });
        },
        "register": function register() {
          if (!this.data.registerusername) {
            alert('用户名不能为空哦!');
            return;
          }
          if (!this.data.registerPassWord) {
            alert('密码不能为空哦!');
            return;
          }
          if (!this.data.registerPassWordR) {
            alert('重复密码不能为空哦!');
            return;
          }
          if (!this.data.registerPhone) {
            alert('手机号码不能为空!');
            return;
          }
          if (this.data.registerPassWord !== this.data.registerPassWordR) {
            alert('两次输入的密码不一致哦!');
            return;
          }
          fetch("//service-eqp55afi-1256763111.gz.apigw.tencentcs.com/release/register", {
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              phone: this.data.registerPhone,
              username: this.data.registerusername,
              password: this.data.registerPassWord,
              code: this.data.registerCode
            })
          }).then(function(response) {
            return response.json();
          }).then(function(res) {
            if (res.err === 0) {
              alert('注册成功!');
              owo.go('/view-loginContent=login');
            } else {
              window.parent.postMessage(JSON.stringify({"type":"owoError", "data": res.message}));
            }
          });
        },
        "sendSMS": function sendSMS() {
          if (!this.data.registerPhone) {
            alert('手机号码不能为空!');
            return;
          }
          if (Date.parse(new Date()) - this.data.smsTime < 60000) {
            alert('发送短信需间隔一分钟!');
            return;
          }
          this.data.smsTime = Date.parse(new Date());
          fetch("//service-eqp55afi-1256763111.gz.apigw.tencentcs.com/release/sendSMS", {
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              phone: this.data.registerPhone
            })
          }).then(function(response) {
            return response.json();
          }).then(function(res) {
            if (res.err === 0) {
              alert('短信已发送!');
            } else {
              alert("发送失败: " + res.message);
            }
          });
        },
        "view": {
          "loginContent": [{
            "_name": "login",
            "_inherit": true
          }, {
            "_name": "register",
            "_inherit": true
          }]
        }
      }
    };
  </script>

  <script src="./static/js/main.js" type="text/javascript" charset="UTF-8"></script>
</body>

</html>